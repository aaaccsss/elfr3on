<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>شحن العملات - وكالة الفرعون</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e293b, #111827);
            color: #e0e7ff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 800;
            color: #dbeafe;
        }

        p, span, label {
            font-weight: 500;
            color: #cbd5e1;
        }

        .glass-effect {
            backdrop-filter: blur(12px);
            background: rgba(31, 41, 55, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        #userAvatar {
            border-radius: 9999px;
            border: 4px solid #2563eb;
            width: 8rem;
            height: 8rem;
            object-fit: cover;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.7);
        }

        .status-indicator {
            position: absolute;
            bottom: -0.5rem;
            right: -0.5rem;
            background-color: #22c55e;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            border: 3px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
        }

        #verifiedBadge {
            background-color: #2563eb;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .stats-box {
            background: #1f2937;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            border: 1px solid #374151;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align Hawkins: 0.3s ease;
        }

        .stats-box:hover {
            background-color: #2563eb;
            color: #dbeafe;
            border-color: #3b82f6;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1;
            color: inherit;
            white-space: nowrap;
            user-select: none;
        }

        .stats-label {
            font-size: 0.875rem;
            color: inherit;
            margin-top: 0.25rem;
            user-select: none;
        }

        .charge-button {
            background: linear-gradient(45deg, #2563eb, #3b82f6);
            transition: all 0.3s ease;
            border-radius: 1rem;
            font-weight: 700;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.6);
            cursor: pointer;
            border: none;
            color: white;
            width: 100%;
        }

        .charge-button:hover:not(:disabled) {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.8);
            transform: translateY(-3px);
        }

        .charge-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .custom-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #e0e7ff;
            font-weight: 600;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.4);
            background-color: #1e293b;
        }

        .coin-package {
            background: #1f2937;
            border: 1px solid #374151;
            transition: box-shadow 0.3s ease, background-color 0.3s ease;
            cursor: pointer;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            color: #dbeafe;
            user-select: none;
        }

        .coin-package:hover {
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
            background-color: #2563eb;
            color: #dbeafe;
            transform: translateY(-5px);
        }

        .coin-package img {
            margin-bottom: 0.75rem;
            width: 3rem;
            height: 3rem;
            object-fit: contain;
            transition: filter 0.3s ease;
        }

        #paymentModal {
            backdrop-filter: blur(15px);
            background: rgba(0, 0, 0, 0.85);
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #paymentModal.active {
            display: flex;
        }

        .payment-content {
            background: #1e293b;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            color: #dbeafe;
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.7);
            text-align: center;
        }

        .payment-step {
            display: none;
        }

        .payment-step.active {
            display: block;
        }

        .payment-content h3 {
            margin-bottom: 1rem;
            font-weight: 900;
            font-size: 1.75rem;
        }

        .payment-amount {
            font-size: 2.5rem;
            font-weight: 900;
            color: #22c55e;
            margin-bottom: 1rem;
        }

        .card-number {
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #93c5fd;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .btn-confirm {
            background-color: #22c55e;
            color: white;
            margin-right: 0.5rem;
        }

        .btn-confirm:hover {
            background-color: #16a34a;
        }

        .btn-cancel {
            background-color: #374151;
            color: #dbeafe;
        }

        .btn-cancel:hover {
            background-color: #4b5563;
        }

        .processing-animation {
            animation: processing 1.5s infinite;
            font-size: 4rem;
            color: #2563eb;
            margin-bottom: 1rem;
        }

        @keyframes processing {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        /* تحسين تصميم الشاشة المنبثقة */
        #supportPopup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            font-family: 'Cairo', sans-serif;
            user-select: none;
        }

        #supportPopup.active {
            display: flex;
            animation: popupScaleIn 0.5s ease-out forwards;
        }

        #supportPopup .popup-content {
            position: relative;
            background: linear-gradient(145deg, #1e293b, #2d3748);
            border-radius: 2rem;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            color: #e0e7ff;
            text-align: center;
            box-shadow:
                0 10px 40px rgba(37, 99, 235, 0.3),
                0 0 20px rgba(59, 130, 246, 0.2);
            overflow: hidden;
            transform-style: preserve-3d;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        #supportPopup .gift-icon {
            font-size: 4.5rem;
            color: #facc15;
            text-shadow: 0 0 12px rgba(250, 204, 21, 0.7);
            margin-bottom: 1.5rem;
            animation: giftBounce 1.8s ease-in-out infinite;
        }

        #supportPopup h3 {
            font-size: 2.25rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
            color: #dbeafe;
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        #supportPopup p {
            font-size: 1.125rem;
            margin: 0.5rem 0;
            color: #cbd5e1;
        }

        #popupUsernameContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
            margin-bottom: 1rem;
        }

        #popupUsername {
            font-size: 1.75rem;
            font-weight: 800;
            color: #22c55e;
            text-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        #copyUsernameBtn {
            background: none;
            border: none;
            cursor: pointer;
            color: #93c5fd;
            transition: color 0.3s ease;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        #copyUsernameBtn:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.1);
        }

        #copyUsernameBtn:active {
            transform: scale(0.95);
        }

        #popupAmount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #facc15;
            text-shadow: 0 0 8px rgba(250, 204, 21, 0.5);
            margin-bottom: 1.5rem;
        }

        .popup-close-btn {
            background: linear-gradient(45deg, #ef4444, #f87171);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
        }

        .popup-close-btn:hover {
            background: linear-gradient(45deg, #f87171, #ef4444);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
            transform: translateY(-2px);
        }

        @keyframes popupScaleIn {
            0% {
                opacity: 0;
                transform: scale(0.8) rotateX(10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateX(0deg);
            }
        }

        @keyframes giftBounce {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-12px) rotate(10deg);
            }
        }

        #confettiCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-6">
        <header class="mb-10 text-center">
            <h1 class="text-5xl mb-2">مرحباً بك في وكالة الفرعون</h1>
            <p class="text-lg text-gray-400 font-medium">شحن  بأسرع وأأمن طريقة</p>
        </header>

        <div id="serverStatus">
            <i class="fas fa-spinner fa-spin"></i> فحص حالة الخادم...
        </div>

        <section class="mb-10">
            <div class="flex max-w-2xl mx-auto gap-4">
                <input
                    type="text"
                    id="usernameInput"
                    placeholder="أدخل اسم المستخدم (بدون @)"
                    class="custom-input flex-grow"
                />
                <button id="searchBtn" onclick="searchUser()">
                    <i class="fas fa-search ml-2"></i>بحث
                </button>
            </div>
        </section>

        <div id="loading" class="hidden glass-effect p-8 text-center max-w-xl mx-auto rounded-2xl mb-10">
            <div class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p class="text-2xl font-bold mb-3" id="loadingText">🔍 جاري البحث...</p>
            <p class="text-gray-400" id="loadingStatus">جاري الاتصال بالخادم...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
        </div>

        <div id="userCard" class="hidden glass-effect p-8 rounded-3xl max-w-4xl mx-auto mb-10">
            <div class="grid lg:grid-cols-2 gap-10">
                <div>
                    <div class="text-center mb-6 relative">
                        <img id="userAvatar" src="" alt="صورة المستخدم" />
                        <div class="status-indicator" title="متصل">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <h2 id="displayName" class="text-4xl font-extrabold mb-1"></h2>
                    <p id="username" class="text-xl text-gray-400 mb-4"></p>
                    <p id="bio" class="text-gray-300 whitespace-pre-line leading-relaxed"></p>
                    <div id="verifiedBadge" class="hidden">
                        <i class="fas fa-check-circle"></i> حساب موثق
                    </div>
                    <div class="grid grid-cols-3 gap-6 mt-8">
                        <div class="stats-box">
                            <div id="followers" class="stats-number icon-blue">0</div>
                            <div class="stats-label">متابعين</div>
                        </div>
                        <div class="stats-box">
                            <div id="following" class="stats-number icon-green">0</div>
                            <div class="stats-label">يتابع</div>
                        </div>
                        <div class="stats-box">
                            <div id="likes" class="stats-number icon-yellow">0</div>
                            <div class="stats-label">إعجابات</div>
                        </div>
                    </div>
                    <div class="mt-8 bg-gray-800 rounded-xl p-4 text-sm text-gray-400">
                        <div class="flex justify-between mb-2">
                            <span>المصدر:</span>
                            <span class="text-green-400 font-semibold">مباشر</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>آخر تحديث:</span>
                            <span id="lastUpdate">الآن</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>من الـ Cache:</span>
                            <span id="cached">لا</span>
                        </div>
                        <div class="flex justify-between">
                            <span>نوع الصورة:</span>
                            <span id="imageType">حقيقية</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-3xl font-bold mb-6 icon-yellow flex items-center gap-3">
                        <i class="fas fa-coins"></i> شحن 
                    </h3>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="coin-package" onclick="selectPackage(100, 0.10, this)">
                            <img src="photo_2025-08-31_06-55-37.jpg" alt="100 عملة" />
                            <div class="text-2xl font-bold text-yellow-400">100</div>
                            <div class="text-sm text-gray-300 mb-1">عملة</div>
                            <div class="text-lg font-bold text-green-400">$0.10</div>
                            <div class="text-xs text-gray-400 line-through">$10.00</div>
                            <div class="mt-2 bg-blue-700 text-blue-300 text-xs px-2 py-1 rounded-full">
                                للمبتدئين
                            </div>
                        </div>
                        <div class="coin-package" onclick="selectPackage(500, 0.50, this)">
                            <img src="photo_2025-08-31_06-55-37.jpg" alt="500 عملة" />
                            <div class="text-2xl font-bold text-yellow-400">500</div>
                            <div class="text-sm text-gray-300 mb-1">عملة</div>
                            <div class="text-lg font-bold text-green-400">$0.50</div>
                            <div class="text-xs text-gray-400 line-through">$50.00</div>
                            <div class="mt-2 bg-purple-700 text-purple-300 text-xs px-2 py-1 rounded-full">
                                أفضل قيمة
                            </div>
                        </div>
                        <div class="coin-package" onclick="selectPackage(1000, 1.00, this)">
                            <img src="photo_2025-08-31_06-55-37.jpg" alt="1000 عملة" />
                            <div class="text-2xl font-bold text-yellow-400">1000</div>
                            <div class="text-sm text-gray-300 mb-1">عملة</div>
                            <div class="text-lg font-bold text-green-400">$1.00</div>
                            <div class="text-xs text-gray-400 line-through">$100.00</div>
                            <div class="mt-2 bg-red-700 text-red-300 text-xs px-2 py-1 rounded-full">
                                الأكثر شعبية
                            </div>
                        </div>
                        <div class="coin-package" onclick="selectPackage(5000, 5.00, this)">
                            <img src="photo_2025-08-31_06-55-37.jpg" alt="5000 عملة" />
                            <div class="text-2xl font-bold text-yellow-400">5000</div>
                            <div class="text-sm text-gray-300 mb-1">عملة</div>
                            <div class="text-lg font-bold text-green-400">$5.00</div>
                            <div class="text-xs text-gray-400 line-through">$500.00</div>
                            <div class="mt-2 bg-green-700 text-green-300 text-xs px-2 py-1 rounded-full">
                                VIP
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 rounded-xl p-4 mb-6">
                        <h4 class="text-lg font-bold mb-3 flex items-center gap-2 icon-blue">
                            <i class="fas fa-sliders-h"></i> شحن مخصص
                        </h4>
                        <div class="flex gap-3">
                            <input
                                type="number"
                                id="customCoins"
                                placeholder="عدد العملات المطلوب"
                                min="1"
                                max="50000"
                                class="custom-input flex-grow"
                            />
                            <button onclick="calculateCustomPrice()" class="bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg transition-colors text-white">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </div>
                        <div id="customPrice" class="text-center mt-2 text-green-400 font-bold"></div>
                        <div class="text-xs text-center mt-1 text-gray-400">
                            💡 السعر: 1 دولار لكل 1000 عملة
                        </div>
                    </div>
                    <div id="selectedPackage" class="bg-gray-800 rounded-xl p-4 mb-6 border border-yellow-500/50 hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-lg font-bold text-yellow-400">الباقة المحددة</div>
                                <div class="text-sm text-gray-300">
                                    <span id="selectedCoins">0</span> عملة - 
                                    <span id="selectedPrice">$0.00</span>
                                </div>
                            </div>
                            <div class="text-2xl">
                                <i class="fas fa-coins text-yellow-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button id="chargeBtn" onclick="processCharge()" class="charge-button opacity-50" disabled>
                            <i class="fas fa-credit-card ml-2"></i>
                            شحن العملات الآن
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="errorMessage" class="hidden glass-effect p-6 rounded-2xl max-w-xl mx-auto mb-10 border border-red-600 text-center text-red-400">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <h3 class="text-xl font-bold mb-2">حدث خطأ!</h3>
            <p id="errorText" class="mb-4"></p>
            <button onclick="hideAll()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg transition-colors text-white font-bold">
                إغلاق
            </button>
        </div>
    </div>

    <div id="supportPopup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 z-50 hidden">
        <div class="popup-content">
            <canvas id="confettiCanvas"></canvas>
            <div class="gift-icon">
                <i class="fas fa-gift"></i>
            </div>
            <h3>تهانينا!</h3>
            <p>لقد استلمت دعمًا جديدًا من</p>
            <div id="popupUsernameContainer">
                <span id="popupUsername" class="font-semibold"></span>
                <button id="copyUsernameBtn" title="نسخ اسم المستخدم">
                    <i class="fas fa-copy text-lg"></i>
                </button>
            </div>
            <p id="popupAmount" class="text-yellow-300 font-bold text-lg mt-2"></p>
            <button onclick="closeSupportPopup()" class="popup-close-btn" aria-label="إغلاق الإشعار">إغلاق</button>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 payment-modal z-50 flex items-center justify-center hidden">
        <div class="payment-content glass-effect">
            <div id="paymentStep1" class="payment-step active">
                <i class="fab fa-cc-visa text-6xl text-blue-400 mb-4"></i>
                <h3>تأكيد الدفع</h3>
                <div class="payment-amount" id="paymentAmount">$0.00</div>
                <div class="card-number">7438 **** **** ****</div>
                <div class="flex justify-center gap-4 mt-6">
                    <button onclick="confirmPayment()" class="btn btn-confirm">
                        <i class="fas fa-check ml-2"></i>تأكيد الدفع
                    </button>
                    <button onclick="closePaymentModal()" class="btn btn-cancel">
                        إلغاء
                    </button>
                </div>
            </div>
            <div id="paymentStep2" class="payment-step">
                <div class="processing-animation mb-4">
                    <i class="fas fa-credit-card"></i>
                </div>
                <h3>جاري معالجة الدفع...</h3>
                <div class="loading-dots mt-6 mb-4">
                    <div></div><div></div><div></div>
                </div>
                <div class="text-sm text-gray-400">يرجى عدم إغلاق النافذة...</div>
            </div>
            <div id="paymentStep3" class="payment-step">
                <div class="w-20 h-20 mx-auto mb-4 bg-green-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-check text-white text-3xl"></i>
                </div>
                <h3 class="text-green-400 mb-4">تم الدفع بنجاح!</h3>
                <div class="bg-green-600/20 border border-green-500/50 rounded-lg p-4 mb-4 text-green-300 text-sm" id="successDetails"></div>
                <button onclick="closePaymentModal()" class="w-full btn btn-confirm">
                    <i class="fas fa-times ml-2"></i>إغلاق
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://elfr3on-y8xg.vercel.app/'; 
        let isSearching = false;
        let currentUser = null;
        let selectedCoins = 0;
        let selectedPrice = 0;

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                document.getElementById('serverStatus').innerHTML = `
                    <i class="fas fa-check-circle text-green-400"></i>
                `;
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = `
                    <i class="fas fa-times-circle text-red-400"></i>
                    خطأ في الاتصال بالخادم - تأكد من تشغيله
                `;
            }
        }

        async function searchUser() {
            if (isSearching) return;
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                showError('يرجى إدخال اسم المستخدم');
                return;
            }
            isSearching = true;
            hideAll();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري البحث...';
            try {
                updateLoadingStatus('جاري الاتصال بالخادم...');
                const response = await fetch(`${API_BASE}/api/user/${username}`);
                if (!response.ok) {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
                updateLoadingStatus('جاري معالجة البيانات...');
                const result = await response.json();
                if (result.success) {
                    currentUser = result.data;
                    displayUser(result.data, result.cached);
                } else {
                    throw new Error(result.error || 'فشل في جلب البيانات');
                }
            } catch (error) {
                showError(`خطأ: ${error.message}`);
            } finally {
                isSearching = false;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').innerHTML = '<i class="fas fa-search ml-2"></i>بحث';
            }
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function displayUser(user, cached = false) {
            const avatar = document.getElementById('userAvatar');
            avatar.src = user.avatar || 'https://via.placeholder.com/150?text=User';
            avatar.alt = user.displayName + ' صورة المستخدم';
            document.getElementById('displayName').textContent = user.displayName;
            document.getElementById('username').textContent = '@' + user.username;
            document.getElementById('bio').textContent = user.bio || 'لا يوجد وصف';
            const verifiedBadge = document.getElementById('verifiedBadge');
            if (user.verified) {
                verifiedBadge.classList.remove('hidden');
            } else {
                verifiedBadge.classList.add('hidden');
            }
            document.getElementById('followers').textContent = formatNumber(user.followerCount || user.followers || 0);
            document.getElementById('following').textContent = formatNumber(user.followingCount || user.following || 0);
            document.getElementById('likes').textContent = formatNumber(user.likesCount || user.likes || 0);
            document.getElementById('lastUpdate').textContent = new Date(user.scrapedAt || Date.now()).toLocaleString('ar-SA');
            document.getElementById('cached').textContent = cached ? 'نعم' : 'لا';
            document.getElementById('imageType').textContent = user.avatarType === 'generated' ? 'مولدة' : 'حقيقية';
            const userCard = document.getElementById('userCard');
            userCard.classList.remove('hidden');
            userCard.style.opacity = '0';
            userCard.style.transform = 'translateY(30px)';
            setTimeout(() => {
                userCard.style.transition = 'all 0.8s ease';
                userCard.style.opacity = '1';
                userCard.style.transform = 'translateY(0)';
            }, 100);
        }

        function selectPackage(coins, price, element) {
            selectedCoins = coins;
            selectedPrice = price;
            document.querySelectorAll('.coin-package').forEach(pkg => {
                pkg.classList.remove('ring-2', 'ring-yellow-400', 'bg-yellow-500/10');
            });
            element.classList.add('ring-2', 'ring-yellow-400', 'bg-yellow-500/10');
            document.getElementById('selectedCoins').textContent = coins;
            document.getElementById('selectedPrice').textContent = '$' + price.toFixed(2);
            document.getElementById('selectedPackage').classList.remove('hidden');
            const chargeBtn = document.getElementById('chargeBtn');
            chargeBtn.disabled = false;
            chargeBtn.classList.remove('opacity-50');
        }

        function calculateCustomPrice() {
            const coins = parseInt(document.getElementById('customCoins').value);
            if (coins && coins > 0) {
                const price = (coins * 0.001).toFixed(2);
                document.getElementById('customPrice').innerHTML = `
                    السعر: $${price}
                    <button onclick="selectCustomPackage(${coins}, ${price})" class="ml-2 bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs text-white">
                        اختيار
                    </button>
                `;
            } else {
                document.getElementById('customPrice').innerHTML = '';
            }
        }

        function selectCustomPackage(coins, price) {
            selectedCoins = coins;
            selectedPrice = parseFloat(price);
            document.querySelectorAll('.coin-package').forEach(pkg => {
                pkg.classList.remove('ring-2', 'ring-yellow-400', 'bg-yellow-500/10');
            });
            document.getElementById('selectedCoins').textContent = coins;
            document.getElementById('selectedPrice').textContent = '$' + selectedPrice.toFixed(2);
            document.getElementById('selectedPackage').classList.remove('hidden');
            const chargeBtn = document.getElementById('chargeBtn');
            chargeBtn.disabled = false;
            chargeBtn.classList.remove('opacity-50');
        }

        function processCharge() {
            if (!currentUser || selectedCoins === 0) {
                showError('يرجى اختيار مستخدم وباقة شحن أولاً');
                return;
            }
            document.getElementById('paymentAmount').textContent = '$' + selectedPrice.toFixed(2);
            showPaymentStep(1);
            document.getElementById('paymentModal').classList.add('active');
        }

        function showPaymentStep(step) {
            document.querySelectorAll('.payment-step').forEach(s => s.classList.remove('active'));
            document.getElementById('paymentStep' + step).classList.add('active');
        }

        function confirmPayment() {
            showPaymentStep(2);
            setTimeout(() => {
                const details = `
                    تم شحن ${selectedCoins} عملة<br>
                    للمستخدم: ${currentUser.displayName}<br>
                    رقم العملية: #${generateTransactionId()}
                `;
                document.getElementById('successDetails').innerHTML = details;
                showPaymentStep(3);
            }, 3000);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            setTimeout(() => {
                showPaymentStep(1);
                resetSelection();
            }, 300);
        }

        function resetSelection() {
            selectedCoins = 0;
            selectedPrice = 0;
            document.getElementById('selectedPackage').classList.add('hidden');
            document.getElementById('selectedCoins').textContent = '0';
            document.getElementById('selectedPrice').textContent = '$0.00';
            document.getElementById('chargeBtn').disabled = true;
            document.getElementById('chargeBtn').classList.add('opacity-50');
            document.getElementById('customCoins').value = '';
            document.getElementById('customPrice').innerHTML = '';
            document.querySelectorAll('.coin-package').forEach(pkg => {
                pkg.classList.remove('ring-2', 'ring-yellow-400', 'bg-yellow-500/10');
            });
        }

        function generateTransactionId() {
            return 'TK' + Date.now().toString().slice(-8) + Math.floor(Math.random() * 1000);
        }

        function formatNumber(num) {
            if (typeof num === 'string') {
                const cleanStr = num.toLowerCase().replace(/[,\s]/g, '');
                const numValue = parseFloat(cleanStr);
                if (cleanStr.includes('k')) return (numValue * 1000).toLocaleString();
                if (cleanStr.includes('m')) return (numValue * 1000000).toLocaleString();
                if (cleanStr.includes('b')) return (numValue * 1000000000).toLocaleString();
                return numValue.toLocaleString();
            }
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorMessage').classList.add('hidden');
            }, 5000);
        }

        function hideAll() {
            document.getElementById('userCard').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        document.getElementById('usernameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUser();
            }
        });

        document.getElementById('customCoins').addEventListener('input', function() {
            calculateCustomPrice();
        });

        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            setInterval(checkServerStatus, 30000);
        });

        const socket = new WebSocket('ws://localhost:9090');

        socket.addEventListener('open', () => {
            console.log('WebSocket متصل');
        });

        socket.addEventListener('message', event => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'support_notification') {
                    showSupportPopup(data.username, data.amount || 0);
                }
            } catch (e) {
                console.error('خطأ في معالجة رسالة WebSocket:', e);
            }
        });

        socket.addEventListener('close', () => {
            console.log('WebSocket تم قطع الاتصال');
        });

        const popup = document.getElementById('supportPopup');
        const usernameEl = document.getElementById('popupUsername');
        const amountEl = document.getElementById('popupAmount');
        const confettiCanvas = document.getElementById('confettiCanvas');
        const ctx = confettiCanvas.getContext('2d');
        let confettiPieces = [];
        let confettiInterval;

        function resizeCanvas() {
            confettiCanvas.width = confettiCanvas.clientWidth;
            confettiCanvas.height = confettiCanvas.clientHeight;
        }

        class ConfettiPiece {
            constructor() {
                this.x = Math.random() * confettiCanvas.width;
                this.y = Math.random() * confettiCanvas.height - confettiCanvas.height;
                this.size = Math.random() * 6 + 3;
                this.speed = Math.random() * 4 + 2;
                this.angle = Math.random() * 2 * Math.PI;
                this.spin = Math.random() * 0.08 + 0.03;
                this.color = ['#facc15', '#22c55e', '#2563eb', '#f87171'][Math.floor(Math.random() * 4)];
                this.opacity = Math.random() * 0.4 + 0.6;
            }
            update() {
                this.y += this.speed;
                this.x += Math.sin(this.angle) * 0.5;
                this.angle += this.spin;
                if (this.y > confettiCanvas.height + this.size) {
                    this.y = -this.size;
                    this.x = Math.random() * confettiCanvas.width;
                }
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(-this.size, 0);
                ctx.lineTo(0, -this.size);
                ctx.lineTo(this.size, 0);
                ctx.lineTo(0, this.size);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        function startConfetti() {
            resizeCanvas();
            confettiPieces = [];
            for (let i = 0; i < 150; i++) {
                confettiPieces.push(new ConfettiPiece());
            }
            confettiInterval = setInterval(() => {
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                confettiPieces.forEach(p => {
                    p.update();
                    p.draw();
                });
            }, 16);
        }

        function stopConfetti() {
            clearInterval(confettiInterval);
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }

        function copyUsername() {
            const username = document.getElementById('popupUsername').textContent;
            navigator.clipboard.writeText(username).then(() => {
                const copyBtn = document.getElementById('copyUsernameBtn');
                copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy text-lg"></i>';
                }, 2000);
            }).catch(err => {
                console.error('فشل في النسخ:', err);
            });
        }

        function showSupportPopup(username, amount) {
            document.getElementById('popupUsername').textContent = username;
            let amountNumber = 0;
            if (typeof amount === 'number') {
                amountNumber = amount;
            } else if (typeof amount === 'string') {
                amountNumber = parseFloat(amount);
                if (isNaN(amountNumber)) amountNumber = 0;
            }
            document.getElementById('popupAmount').textContent = `عدد العملات: ${amountNumber.toFixed(0)}`;
            popup.classList.remove('hidden');
            popup.classList.add('active');
            startConfetti();
            setTimeout(() => {
                closeSupportPopup();
            }, 10000);
            const copyBtn = document.getElementById('copyUsernameBtn');
            copyBtn.onclick = copyUsername;
        }

        function closeSupportPopup() {
            popup.classList.add('hidden');
            popup.classList.remove('active');
            stopConfetti();
        }

        window.addEventListener('resize', () => {
            if (!popup.classList.contains('hidden')) {
                resizeCanvas();
            }
        });
    </script>
</body>
</html>
